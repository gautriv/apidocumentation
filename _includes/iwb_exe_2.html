<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Styling for buttons */
        .exercise-button, .solution-button {
            background-color: #4a6ef5;
            color: #fff;
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            margin: 12px 8px;
            display: inline-block;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .exercise-button:hover, .solution-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .exercise-button {
            background-color: #4a6ef5;
        }
        
        .solution-button {
            background-color: #28a745;
        }

        /* Hidden content by default */
        .exercise-content, .solution-content {
            display: none;
            padding: 20px;
            border: 1px solid #e0e0e0;
            background-color: #f9f9f9;
            border-radius: 12px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .exercise-content h3, .solution-content h3 {
            color: #2c3e50;
            border-bottom: 2px solid #eaeaea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table, th, td {
            border: 1px solid #e0e0e0;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
        }

        th {
            background-color: #f0f5ff;
            font-weight: bold;
            color: #344563;
        }
        
        tr:nth-child(even) {
            background-color: #f8fafd;
        }
        
        /* Code block styling */
        pre {
            background-color: #f0f4f8;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border-left: 4px solid #4a6ef5;
            font-family: monospace;
            margin: 15px 0;
        }
        
        /* List styling */
        ul, ol {
            padding-left: 25px;
        }
        
        ul li, ol li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        /* Highlight important text */
        strong {
            color: #2c3e50;
        }
        
        code {
            background-color: #f0f4f8;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        /* Security comparison box */
        .security-comparison {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        
        .security-method {
            flex: 1;
            min-width: 250px;
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .security-method h5 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #eaeaea;
            padding-bottom: 8px;
        }
        
        .note-box {
            background-color: #fff8e1;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .warning-box {
            background-color: #ffebee;
            border-left: 5px solid #f44336;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- Buttons to toggle Exercise 2 and its Solution -->
    <button class="exercise-button" onclick="toggleExercise('exercise2')">Exercise 2</button>
    <button class="solution-button" onclick="toggleSolution('solution2', 'exercise2')">Solution to Exercise 2</button>

    <!-- Exercise 2 Content (Initially Hidden) -->
    <div class="exercise-content" id="exercise2">
        <h3>Exercise 2: Documenting Advanced Webhook Security</h3>
        <p><strong>Scenario:</strong> You are creating documentation for a <strong>healthcare data API</strong> that uses webhooks to notify systems about patient record updates. Due to the sensitive nature of the data, the platform implements <strong>multiple layers of security</strong> for webhook delivery.</p>

        <p><strong>Key Challenge:</strong> You need to document comprehensive security measures while making them accessible to developers with varying security expertise.</p>

        <h4>Security Requirements</h4>
        <p>The webhook system implements the following security measures:</p>
        <ul>
            <li><strong>HMAC Signature Verification</strong> - All webhooks are signed with a secret key.</li>
            <li><strong>Mutual TLS Authentication</strong> - Both the webhook sender and receiver verify each other's certificates.</li>
            <li><strong>IP Allowlisting</strong> - Webhooks are only accepted from specific sender IP addresses.</li>
            <li><strong>OAuth 2.0 Authentication</strong> - Webhook deliveries include an OAuth bearer token.</li>
            <li><strong>Payload Encryption</strong> - Sensitive data within webhooks can be encrypted.</li>
        </ul>

        <h4>Your Task</h4>
        <p>Create comprehensive documentation that:</p>
        <ol>
            <li>Explains each security mechanism and its purpose</li>
            <li>Provides implementation guidance for each security method</li>
            <li>Includes code samples for verification and authentication</li>
            <li>Outlines security best practices for webhook consumers</li>
            <li>Creates a decision flowchart for which security measures to implement based on sensitivity needs</li>
        </ol>

        <h4>Example Request Headers</h4>
        <pre>
POST /webhook-endpoint HTTP/1.1
Host: receiver.example.com
Content-Type: application/json
X-Webhook-Signature: sha256=7b52009b64fd0a2a49e6d8a939753077792b0554
X-Webhook-ID: whid_12345
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
User-Agent: HealthAPI-Webhook/1.0</pre>

        <h4>Sample Webhook Payload</h4>
        <pre>
{
    "event": "patient.record.updated",
    "timestamp": "2024-05-15T15:30:22Z",
    "webhook_id": "whid_12345",
    "data": {
        "patient_id": "enc_pat_9876543",
        "record_type": "medication",
        "action": "prescribed",
        "updated_by": "practitioner_id_456",
        "encrypted_details": "eyJhbGciOiJSU0EtT0FFUC0yNTYiLCJlbmMiOiJBMjU2R0NNIn0..."
    }
}</pre>
    </div>

    <!-- Solution to Exercise 2 (Initially Hidden) -->
    <div class="solution-content" id="solution2">
        <h3>Solution to Exercise 2: Advanced Webhook Security Documentation</h3>

        <h4>1. Webhook Security Overview</h4>
        <p>Our healthcare API implements multiple security layers to protect sensitive patient data transmitted via webhooks. These security measures ensure:</p>
        <ul>
            <li>Webhook authenticity (the webhook truly came from our system)</li>
            <li>Data integrity (the payload hasn't been tampered with)</li>
            <li>Data confidentiality (sensitive information remains private)</li>
            <li>Access control (only authorized systems receive webhooks)</li>
        </ul>

        <div class="warning-box">
            <p><strong>Important:</strong> Due to the sensitive nature of healthcare data, we recommend implementing <em>all</em> security measures described below for production environments. For development environments, signature verification is the minimum requirement.</p>
        </div>

        <h4>2. Security Mechanisms Explained</h4>
        
        <div class="security-comparison">
            <div class="security-method">
                <h5>HMAC Signature Verification</h5>
                <p><strong>Purpose:</strong> Ensures webhook authenticity and data integrity.</p>
                <p><strong>Implementation:</strong> We sign all webhook payloads with your webhook secret using HMAC-SHA256.</p>
                <p><strong>Verification Process:</strong></p>
                <ol>
                    <li>Extract the <code>X-Webhook-Signature</code> header</li>
                    <li>Compute an HMAC-SHA256 of the raw request body using your webhook secret</li>
                    <li>Compare your computed signature with the received signature</li>
                </ol>
            </div>
            
            <div class="security-method">
                <h5>Mutual TLS (mTLS)</h5>
                <p><strong>Purpose:</strong> Provides two-way authentication between webhook sender and receiver.</p>
                <p><strong>Implementation:</strong> Both our servers and your endpoint present and verify TLS certificates.</p>
                <p><strong>Setup Process:</strong></p>
                <ol>
                    <li>Generate a client certificate and private key</li>
                    <li>Upload your client certificate to our webhook configuration</li>
                    <li>Configure your server to request client certificates</li>
                    <li>Verify incoming requests against our root certificate</li>
                </ol>
            </div>
        </div>
        
        <div class="security-comparison">
            <div class="security-method">
                <h5>IP Allowlisting</h5>
                <p><strong>Purpose:</strong> Restricts webhook receivers to only accept requests from authorized IP addresses.</p>
                <p><strong>Implementation:</strong> Configure your firewall or application to accept webhook requests only from our documented IP ranges.</p>
                <p><strong>Current IP Ranges:</strong></p>
                <ul>
                    <li>192.0.2.0/24 (Primary datacenter)</li>
                    <li>198.51.100.0/24 (Secondary datacenter)</li>
                </ul>
                <div class="note-box">
                    <p>We recommend implementing IP allowlisting at both the network and application levels for defense in depth.</p>
                </div>
            </div>
            
            <div class="security-method">
                <h5>OAuth 2.0 Authentication</h5>
                <p><strong>Purpose:</strong> Provides an additional layer of authentication through access tokens.</p>
                <p><strong>Implementation:</strong> Each webhook includes a Bearer token in the Authorization header.</p>
                <p><strong>Verification Process:</strong></p>
                <ol>
                    <li>Extract the Bearer token from the Authorization header</li>
                    <li>Verify the token against our OAuth token introspection endpoint</li>
                    <li>Check token scopes to ensure proper authorization</li>
                </ol>
            </div>
        </div>
        
        <div class="security-method">
            <h5>Payload Encryption</h5>
            <p><strong>Purpose:</strong> Protects highly sensitive data fields with an additional layer of encryption.</p>
            <p><strong>Implementation:</strong> Certain fields in the webhook payload (like <code>encrypted_details</code>) are encrypted using your public key.</p>
            <p><strong>Decryption Process:</strong></p>
            <ol>
                <li>Generate an RSA key pair if you don't already have one</li>
                <li>Upload your public key to our webhook configuration</li>
                <li>Use your private key to decrypt the <code>encrypted_details</code> field</li>
            </ol>
            <div class="note-box">
                <p>Payload encryption is always used for fields containing protected health information (PHI).</p>
            </div>
        </div>

        <h4>3. Implementation Code Samples</h4>
        
        <h5>Signature Verification (Node.js)</h5>
        <pre>
const crypto = require('crypto');

function verifyWebhookSignature(payload, signature, secret) {
  const hmac = crypto.createHmac('sha256', secret);
  const computedSignature = 'sha256=' + hmac.update(payload).digest('hex');
  return crypto.timingSafeEqual(
    Buffer.from(computedSignature),
    Buffer.from(signature)
  );
}

app.post('/webhook-endpoint', (req, res) => {
  const signature = req.headers['x-webhook-signature'];
  const payload = JSON.stringify(req.body);
  const webhookSecret = process.env.WEBHOOK_SECRET;
  
  if (!verifyWebhookSignature(payload, signature, webhookSecret)) {
    return res.status(401).send('Invalid signature');
  }
  
  // Process the webhook
  res.status(200).send('Webhook received');
});</pre>

        <h5>Decrypt Sensitive Data (Python)</h5>
        <pre>
from cryptography.hazmat.primitives.asymmetric import padding
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives.serialization import load_pem_private_key
import base64
import json

def decrypt_webhook_data(encrypted_data, private_key_path, private_key_password=None):
    # Load the private key
    with open(private_key_path, "rb") as key_file:
        private_key = load_pem_private_key(
            key_file.read(),
            password=private_key_password,
            backend=default_backend()
        )
    
    # Base64 decode the encrypted data
    encrypted_bytes = base64.b64decode(encrypted_data)
    
    # Decrypt the data
    decrypted_bytes = private_key.decrypt(
        encrypted_bytes,
        padding.OAEP(
            mgf=padding.MGF1(algorithm=hashes.SHA256()),
            algorithm=hashes.SHA256(),
            label=None
        )
    )
    
    # Parse and return the decrypted JSON
    return json.loads(decrypted_bytes.decode('utf-8'))</pre>

        <h4>4. Security Measures Decision Guide</h4>
        <table>
            <tr>
                <th>Security Concern</th>
                <th>Recommended Security Measures</th>
            </tr>
            <tr>
                <td>Basic authentication and integrity</td>
                <td>HMAC Signature Verification (required for all integrations)</td>
            </tr>
            <tr>
                <td>Protection against man-in-the-middle attacks</td>
                <td>HMAC Signature Verification + Mutual TLS</td>
            </tr>
            <tr>
                <td>Ensuring only your servers receive data</td>
                <td>HMAC Signature Verification + IP Allowlisting</td>
            </tr>
            <tr>
                <td>Maximum security for PHI data</td>
                <td>All security measures (HMAC + mTLS + IP Allowlisting + OAuth + Payload Encryption)</td>
            </tr>
        </table>

        <h4>5. Security Best Practices</h4>
        <ol>
            <li><strong>Store secrets securely</strong> - Never hardcode webhook secrets or private keys in your application code or source control.</li>
            <li><strong>Implement defense in depth</strong> - Layer multiple security mechanisms rather than relying on just one.</li>
            <li><strong>Use environment-specific keys</strong> - Use different webhook secrets and certificates for development, staging, and production.</li>
            <li><strong>Rotate secrets regularly</strong> - Change webhook secrets and certificates at least every 90 days.</li>
            <li><strong>Implement proper logging</strong> - Log all webhook validation failures for security monitoring and auditing.</li>
            <li><strong>Set up alerts</strong> - Create alerts for repeated webhook validation failures, which could indicate an attack attempt.</li>
            <li><strong>Validate all inputs</strong> - Even after verifying the webhook signature, validate and sanitize all input data.</li>
        </ol>

        <div class="note-box">
            <p><strong>Note:</strong> For compliance with healthcare regulations (such as HIPAA), maintain audit logs of all successful and failed webhook deliveries, including timestamps, IP addresses, and event types.</p>
        </div>
    </div>

    <script>
        function toggleExercise(exerciseId) {
            document.getElementById(exerciseId).style.display = "block";
            document.getElementById("solution2").style.display = "none";
        }

        function toggleSolution(solutionId, exerciseId) {
            document.getElementById(solutionId).style.display = "block";
            document.getElementById(exerciseId).style.display = "none";
        }
    </script>

</body>
</html> 